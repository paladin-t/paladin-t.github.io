<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Movement is a very basic concept in video games, it could be as simple as accumulating steps to a position value. This article introduces a smooth movement algorithm with tolerant sliding, which offers good adaptivity to various tile-based scenes.">
  <meta name="twitter:card" content="Movement is a very basic concept in video games, it could be as simple as accumulating steps to a position value. This article introduces a smooth movement algorithm with tolerant sliding, which offers good adaptivity to various tile-based scenes.">
  <meta name="twitter:image" property="twitter:image" content="https://user-images.githubusercontent.com/2062224/135716904-135f586f-af58-4962-8c0b-d25f9d2ab9be.jpg">
  <meta name="og:title" property="og:title" content="Smooth Tile-based Movement Algorithm with Sliding">
  <meta name="og:description" property="og:description" content="Movement is a very basic concept in video games, it could be as simple as accumulating steps to a position value. This article introduces a smooth movement algorithm with tolerant sliding, which offers good adaptivity to various tile-based scenes.">
  <meta name="og:image" property="og:image" content="https://user-images.githubusercontent.com/2062224/135716904-135f586f-af58-4962-8c0b-d25f9d2ab9be.jpg">
  <title>Tony Wang - Articles</title>
  <link rel="alternate" type="application/rss+xml" title="Tony Wang - Homepage" href="../feed.xml" />
  <link rel="shortcut icon" href="../favicon.ico" />
  <link rel="apple-touch-icon" href="../imgs/avatar.png" />
  <link rel="stylesheet" type="text/css" href="../index.css">
  <link rel="stylesheet" type="text/css" href="../prism.css">
  <link rel="stylesheet" type="text/css" href="../article.css">
</head>
<body onclick>
  <div class="sidenav">
    <div class="sidebar">
      <p align="center" class="title">
        Contents
      </p>
      <a href="../#top">* Home</a>
      <a href="../#kits">* Kits</a>
      <a href="../#games">* Games</a>
      <a href="../#tiny">* Tiny</a>
      <a href="../#articles">* Articles</a>
      * <a href="../feed.xml" target="_blank" class="label" style="display: inline; color: white;">RSS</a>
    </div>
  </div>
  <div class="page">
    <a id="top" href="#top"></a>
    <p align="center" class="title">
      <a href="https://paladin-t.github.io/">Tony Wang</a>
    </p>
    <div class="content">
      <p align="left">
        <a href="https://store.steampowered.com/developer/tony">Steam</a> |
        <a href="https://tonywang.itch.io/">Itch</a> |
        <a href="https://twitter.com/wangrenxin">Twitter</a> |
        <a href="https://github.com/paladin-t">GitHub</a>
      </p>
      <div id="container">
        <div id="left">
          <div id="article-avatar">
            <img src="../imgs/avatar.png" id="avatar">
          </div>
        </div>
        <div id="right">
          <div class="article-title" id="article-title">
            Smooth Tile-based Movement Algorithm with Sliding
          </div>
          <button class="button" id="font" style="width: 4em; font-size: 8px;">Font</button>
        </div>
      </div>

      <hr>
      <div id="article">
        <div id="article-content" class="article-content">
          <!-- BEGIN CONTENT -->
            <p>[<a href="https://paladin-t.github.io/">Home</a>|<a href="https://paladin-t.github.io/#articles">All articles</a>|<a href="https://paladin-t.github.io/articles/smooth-tile-based-movement-algorithm-with-sliding.html">Permalink</a>]</p>
            <h2 id="overview">Overview</h2>
            <p>Movement is a very basic concept in video games, it could be as simple as accumulating steps to a position value. This article introduces a smooth movement algorithm with tolerant sliding, which offers good adaptivity to various tile-based scenes.</p>
            <h2 id="objective">Objective</h2>
            <p>Remember how smooth the control was when playing the <a href="https://en.wikipedia.org/wiki/Bomberman_(1983_video_game)">Bomberman</a>?</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387772-83f43500-290f-11eb-849d-801ecaf1c6d1.png" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;">
            <div style="color: gray; font-size: 8px;" align="center">Bomberman</div>
            <p>If press right, for example, while there is a block tile near your bomberman's feet, the character will try moving into his offset direction (relative to the block) on another axis to avoid blocking, then continue into the desired direction.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387802-92425100-290f-11eb-9ccb-c4a6385bf884.png" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;">
            <div style="color: gray; font-size: 8px;" align="center">Pressing right</div>
            <p>Our goal is to reproduce this tactile feel and furthermore make it adaptable to different character and tile size.</p>
            <h2 id="grid-stepped-movement">Grid-stepped movement</h2>
            <p>Starting from the simplest attempt, assuming we got a small tile map:</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387812-940c1480-290f-11eb-91b8-d7e5327c1ba1.png" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;">
            <div style="color: gray; font-size: 8px;" align="center">Tile map</div>
            <p>Position could be abstracted to dual integer values for x, y respectively. Then the moving and rendering code would be:</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token keyword">local</span> pos <span class="token operator">=</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">local</span> hero <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'hero.spr'</span><span class="token punctuation">)</span>
            <span class="token keyword">local</span> ground <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'ground.map'</span><span class="token punctuation">)</span>
            <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">-- Grid-wise move.</span>
              <span class="token keyword">if</span> <span class="token function">keyp</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Left<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>x <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span>
              <span class="token keyword">elseif</span> <span class="token function">keyp</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Right<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>x <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token keyword">if</span> <span class="token function">keyp</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Up<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>y <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span>
              <span class="token keyword">elseif</span> <span class="token function">keyp</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Down<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>y <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token comment">-- Pixelated rendering.</span>
              <span class="token function">map</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token function">spr</span><span class="token punctuation">(</span>hero<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>x <span class="token operator">*</span> TILE_SIZE<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y <span class="token operator">*</span> TILE_SIZE<span class="token punctuation">)</span>
            <span class="token keyword">end</span></code></pre>
            <p>Object position and tile index share same grid unit in this situation.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387816-94a4ab00-290f-11eb-80f1-158806b1ac10.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Grid-stepped</div>
            <h2 id="pixel-stepped-movement">Pixel-stepped movement</h2>
            <p>The grid-stepped code can be modified to a pixel-stepped version by simply changing the last sprite rendering line:</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token keyword">local</span> pos <span class="token operator">=</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">local</span> hero <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'hero.spr'</span><span class="token punctuation">)</span>
            <span class="token keyword">local</span> ground <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'ground.map'</span><span class="token punctuation">)</span>
            <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">-- Pixelated move.</span>
              <span class="token keyword">if</span> <span class="token function">key</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Left<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>x <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span>
              <span class="token keyword">elseif</span> <span class="token function">key</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Right<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>x <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token keyword">if</span> <span class="token function">key</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Up<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>y <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span>
              <span class="token keyword">elseif</span> <span class="token function">key</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Down<span class="token punctuation">)</span> <span class="token keyword">then</span>
                pos<span class="token punctuation">.</span>y <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token comment">-- Pixelated rendering.</span>
              <span class="token function">map</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token function">spr</span><span class="token punctuation">(</span>hero<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
            <span class="token keyword">end</span></code></pre>
            <p>Now object position uses pixel unit same to rendering. It looks smoother than the previous version.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387823-95d5d800-290f-11eb-87ce-ab82bb099b59.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Pixel-stepped</div>
            <h2 id="collision-detection">Collision detection</h2>
            <p>We didn't count any time factor in this ideal pseudo code, but the later code looks even simpler than the former, how come? Consider adding collision detection against tiles to tell whether it's movable. The code shall be:</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token comment">-- Grid-stepped.</span>
            <span class="token keyword">function</span> <span class="token function">isMovable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">local</span> index <span class="token operator">=</span> pos <span class="token operator">+</span> expDir
              <span class="token keyword">local</span> tile <span class="token operator">=</span> <span class="token function">mget</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> index<span class="token punctuation">.</span>x<span class="token punctuation">,</span> index<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
              <span class="token keyword">local</span> movable <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span>
              <span class="token keyword">return</span> movable
            <span class="token keyword">end</span></code></pre>
            <p>We need to apply a pixel-to-grid conversion before accessing map tiles for pixel-stepped:</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token comment">-- Pixel-stepped.</span>
            <span class="token keyword">function</span> <span class="token function">isMovable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">local</span> newPos <span class="token operator">=</span> pos <span class="token operator">+</span> expDir
              <span class="token keyword">local</span> index <span class="token operator">=</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>
                math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>x <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>y <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
              <span class="token keyword">local</span> tile <span class="token operator">=</span> <span class="token function">mget</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> index<span class="token punctuation">.</span>x<span class="token punctuation">,</span> index<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
              <span class="token keyword">local</span> movable <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span>
              <span class="token keyword">return</span> movable
            <span class="token keyword">end</span></code></pre>
            <p>Things are getting more complicated from here, but no need to worry.</p>
            <p>The position is yet no longer truncated in grids, we can't determine whether it's movable or not unless checking all the possible swept ways ahead a character's front edge of movement.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387831-97070500-290f-11eb-9645-cf12a49d9380.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Multiple scan lines</div>
            <p>We may as well call it "scan line" in this article. In real projects, more scan lines means more CPU consumption. The good news is that we can simplify this evaluation to several checkings with gap rather than doing that for every pixel line.</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token keyword">local</span> STEP_COUNT <span class="token operator">=</span> <span class="token number">3</span>
            <span class="token keyword">function</span> <span class="token function">isVerticallyMovable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">local</span> step <span class="token operator">=</span> CHAR_SIZE <span class="token operator">/</span> STEP_COUNT
              <span class="token keyword">local</span> beginX <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> expDir<span class="token punctuation">.</span>x
              <span class="token keyword">local</span> endX <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> expDir<span class="token punctuation">.</span>x <span class="token operator">+</span> CHAR_SIZE
              <span class="token keyword">local</span> movable <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token keyword">for</span> x <span class="token operator">=</span> beginX<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> step <span class="token keyword">do</span>
                <span class="token keyword">local</span> newPos <span class="token operator">=</span> pos <span class="token operator">+</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> expDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
                <span class="token keyword">local</span> index <span class="token operator">=</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>
                  math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>x <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>y <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">local</span> tile <span class="token operator">=</span> <span class="token function">mget</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> index<span class="token punctuation">.</span>x<span class="token punctuation">,</span> index<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span> <span class="token keyword">then</span>
                  movable <span class="token operator">=</span> <span class="token boolean">false</span>
                  <span class="token keyword">break</span>
                <span class="token keyword">end</span>
              <span class="token keyword">end</span>
              <span class="token keyword">return</span> movable
            <span class="token keyword">end</span></code></pre>
            <p>The additional benefit is that this algorithm also works with different character and tile size now.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387837-979f9b80-290f-11eb-9e78-15c6dc566a14.png" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Small character</div>
            <img src="https://user-images.githubusercontent.com/2062224/99387842-98d0c880-290f-11eb-86e4-13d239368a03.png" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Big character</div>
            <h2 id="sliding-optimization">Sliding optimization</h2>
            <p>You still have to align your character carefully to walk through a narrow passage until now. To optimize the behaviour, first shrink the bundle width of scan lines to fit for tolerance.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387845-99695f00-290f-11eb-8f8c-e7300daf739c.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Shrink for tolerance</div>
            <p>Secondly, calculate a movable rate to tell how much it's passable through.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387847-9a01f580-290f-11eb-88d1-c35cf6d866d0.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Movable rate</div>
            <p>Passed count of scan lines divides total count for the rate:</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token keyword">local</span> SHRINK_SIZE <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">local</span> MOVABLE_RATE <span class="token operator">=</span> <span class="token number">0.6667</span>
            <span class="token keyword">local</span> STEP_COUNT <span class="token operator">=</span> <span class="token number">3</span>
            <span class="token keyword">function</span> <span class="token function">isVerticallyMovable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">local</span> step <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR_SIZE <span class="token operator">-</span> SHRINK_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> STEP_COUNT
              <span class="token keyword">local</span> beginX <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> expDir<span class="token punctuation">.</span>x <span class="token operator">+</span> SHRINK_SIZE
              <span class="token keyword">local</span> endX <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> expDir<span class="token punctuation">.</span>x <span class="token operator">+</span> CHAR_SIZE <span class="token operator">-</span> SHRINK_SIZE
              <span class="token keyword">local</span> passed <span class="token operator">=</span> <span class="token number">0</span>
              <span class="token keyword">local</span> total <span class="token operator">=</span> <span class="token number">0</span>
              <span class="token keyword">for</span> x <span class="token operator">=</span> beginX<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> step <span class="token keyword">do</span>
                <span class="token keyword">local</span> newPos <span class="token operator">=</span> pos <span class="token operator">+</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> expDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
                <span class="token keyword">local</span> index <span class="token operator">=</span> Vec2<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>
                  math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>x <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>y <span class="token operator">/</span> TILE_SIZE<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">local</span> tile <span class="token operator">=</span> <span class="token function">mget</span><span class="token punctuation">(</span>ground<span class="token punctuation">,</span> index<span class="token punctuation">.</span>x<span class="token punctuation">,</span> index<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span> <span class="token keyword">then</span>
                  passed <span class="token operator">=</span> passed <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token keyword">end</span>
                total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token keyword">local</span> movable <span class="token operator">=</span> passed <span class="token operator">/</span> total <span class="token operator">&gt;=</span> MOVABLE_RATE
              <span class="token keyword">return</span> movable
            <span class="token keyword">end</span></code></pre>
            <p>And eventually, if the rate is sufficient to move but still blocked by something, we do a sliding on the other axis to make a minor correction for further movement.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387850-9a9a8c00-290f-11eb-8dad-66ea824df864.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">Smooth movement</div>
            <h2 id="one-way-platform">One-way platform</h2>
            <p>In some games, you can jump through upward a platform, then the platform supports you from falling down; or you walk through a door but there's no way back... We call this a one-way platform or one-way door. We can achieve this behaviour by adding a mask parameter for conditional block.</p>
            <pre class=" language-lua"><code class=" language-lua" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token keyword">local</span> NONE<span class="token punctuation">,</span> LEFT<span class="token punctuation">,</span> RIGHT<span class="token punctuation">,</span> UP<span class="token punctuation">,</span> DOWN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">function</span> <span class="token function">isVerticallyMovable</span><span class="token punctuation">(</span>passMask<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token keyword">for</span> x <span class="token operator">=</span> beginX<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> step <span class="token keyword">do</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">local</span> mask <span class="token operator">=</span> expDir<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">and</span> UP <span class="token keyword">or</span> DOWN
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>passMask <span class="token operator">&amp;</span> mask <span class="token operator">~</span><span class="token operator">=</span> NONE<span class="token punctuation">)</span> <span class="token keyword">then</span>
                  passed <span class="token operator">=</span> passed <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token keyword">end</span>
                total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">1</span>
              <span class="token keyword">end</span>
              <span class="token keyword">local</span> movable <span class="token operator">=</span> passed <span class="token operator">/</span> total <span class="token operator">&gt;=</span> MOVABLE_RATE
              <span class="token keyword">return</span> movable
            <span class="token keyword">end</span></code></pre>
            <p>Now it becomes upward movable when pass <code class=" language-auto" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;">UP</code> to the function.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387852-9b332280-290f-11eb-855a-d7fcdd7c9a33.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;" width="320">
            <div style="color: gray; font-size: 8px;" align="center">One-way platform</div>
            <h2 id="applications">Applications</h2>
            <p>This algorithm works smoothly in top-down and platformer games. And the idea also fits well in properly organized 3D scenes.</p>
            <img src="https://user-images.githubusercontent.com/2062224/99387855-9c644f80-290f-11eb-83c9-50068e55f7d9.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;">
            <div style="color: gray; font-size: 8px;" align="center">Top-down</div>
            <img src="https://user-images.githubusercontent.com/2062224/99387862-9ec6a980-290f-11eb-81d7-99f3384718f8.gif" style="display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated;">
            <div style="color: gray; font-size: 8px;" align="center">Platformer</div>
            <h2 id="known-issues">Known issues</h2>
            <h3 id="penetration-problem">Penetration problem</h3>
            <p>This algorithm doesn't forbid penetration through a tile if a single step is greater than the tile size. However, you can split a big step into several sub steps to avoid undesired penetration.</p>
            <h3 id="real-number-precision">Real number precision</h3>
            <p>The precision of <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE-754</a> standardized real numbers are limited. An issue will manifest when move at the border area of a big map. It is inaccurate to add a small step number to a big position number. Using double precision instead of single precision would relief it, but it only respites the inaccuracy till a larger scale. A workable solution is to apply offset to everything (including characters, map, camera, etc.) to project values inside a computable range all the way.</p>
            <h2 id="gist-code">Gist Code</h2>
            <p>You are free to copy, use and port this <code class=" language-auto" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;">Walker</code> algorithm code in C++ under the BSD 3-Clause License. Replace the <code class=" language-auto" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;">Math</code> and <code class=" language-auto" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;">Vec2</code> polyfill however you want in your actual project.</p>
            <p>Implementation:</p>
            <pre class=" language-cpp"><code class=" language-cpp" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;"><span class="token comment">/*
            ** BSD 3-Clause License
            **
            ** Copyright (C) 2020 Tony Wang, all rights reserved.
            **
            ** Redistribution and use in source and binary forms, with or without
            ** modification, are permitted provided that the following conditions are met:
            **
            ** * Redistributions of source code must retain the above copyright notice, this
            **   list of conditions and the following disclaimer.
            **
            ** * Redistributions in binary form must reproduce the above copyright notice,
            **   this list of conditions and the following disclaimer in the documentation
            **   and/or other materials provided with the distribution.
            **
            ** * Neither the name of the copyright holder nor the names of its
            **   contributors may be used to endorse or promote products derived from
            **   this software without specific prior written permission.
            **
            ** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
            ** AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
            ** IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
            ** DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
            ** FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
            ** DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
            ** SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
            ** CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
            ** OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
            ** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
            */</span>
            #<span class="token keyword">ifndef</span> __WALKER_H__
            #<span class="token keyword">define</span> __WALKER_H__
            #<span class="token keyword">include</span> <span class="token operator">&lt;</span>cmath<span class="token operator">&gt;</span>
            #<span class="token keyword">include</span> <span class="token operator">&lt;</span>functional<span class="token operator">&gt;</span>
            #<span class="token keyword">ifndef</span> GRID_DEFAULT_SIZE
            #  <span class="token keyword">define</span> GRID_DEFAULT_SIZE <span class="token number">8</span>
            #<span class="token keyword">endif</span> <span class="token comment">/* GRID_DEFAULT_SIZE */</span>
            <span class="token keyword">struct</span> Math <span class="token punctuation">{</span>
              <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sign</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">typedef</span> <span class="token keyword">float</span> Real<span class="token punctuation">;</span>
            <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token punctuation">,</span> <span class="token keyword">typename</span> R <span class="token operator">=</span> Real<span class="token operator">&gt;</span> <span class="token keyword">struct</span> Vec2 <span class="token punctuation">{</span>
              T x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
              T y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
              <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">}</span>
              <span class="token function">Vec2</span><span class="token punctuation">(</span>T x_<span class="token punctuation">,</span> T y_<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">x</span><span class="token punctuation">(</span>x_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>y_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">}</span>
              <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vec2 <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                x <span class="token operator">=</span> other<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                y <span class="token operator">=</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              Vec2 <span class="token operator">&amp;</span>operator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Vec2 <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                x <span class="token operator">=</span> other<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                y <span class="token operator">=</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">*</span>this<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">bool</span> operator <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Vec2 <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> x <span class="token operator">==</span> other<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">bool</span> operator <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Vec2 <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> x <span class="token operator">!=</span> other<span class="token punctuation">.</span>x <span class="token operator">||</span> y <span class="token operator">!=</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              R <span class="token function">length</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>R<span class="token punctuation">)</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">typedef</span> Vec2<span class="token operator">&lt;</span>Real<span class="token operator">&gt;</span> Vec2f<span class="token punctuation">;</span>
            <span class="token keyword">typedef</span> Vec2<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Vec2i<span class="token punctuation">;</span>
            <span class="token keyword">class</span> <span class="token class-name">Walker</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span><span class="token punctuation">:</span>
              <span class="token keyword">enum</span> Directions <span class="token punctuation">{</span>
                NONE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                LEFT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
                RIGHT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
                UP <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
                DOWN <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">3</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token keyword">struct</span> Blocking <span class="token punctuation">{</span>
                <span class="token keyword">bool</span> block <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">unsigned</span> pass <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token function">Blocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                <span class="token function">Blocking</span><span class="token punctuation">(</span><span class="token keyword">bool</span> blk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> pass_<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">block</span><span class="token punctuation">(</span>blk<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">pass</span><span class="token punctuation">(</span>pass_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token keyword">typedef</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token operator">&lt;</span><span class="token function">Blocking</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vec2i <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> BlockingHandler<span class="token punctuation">;</span>
            <span class="token keyword">public</span><span class="token punctuation">:</span>
              <span class="token function">Walker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">}</span>
              <span class="token operator">~</span><span class="token function">Walker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">}</span>
              Vec2i <span class="token function">objectSize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> _objSize<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">void</span> <span class="token function">objectSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vec2i <span class="token operator">&amp;</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _objSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              Vec2i <span class="token function">tileSize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> _tileSize<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">void</span> <span class="token function">tileSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vec2i <span class="token operator">&amp;</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _tileSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              Vec2f <span class="token function">offset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> _offset<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">void</span> <span class="token function">offset</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vec2f <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token comment">/**
               * @brief Solves whether a specific object is movable into a direction, and
               *   tells the movable vector.
               *
               * @param[in] objPos The object position.
               * @param[in] expDir The expected direction vector.
               * @param[in] block A function which evaluates walkable state in scene.
               * @param[out] newDir Evaluated movement vector.
               * @param[in] slidable The slidable factor.
               * @return Positive for movement length, or 0 for blocked.
               */</span>
              <span class="token keyword">int</span> <span class="token function">solve</span><span class="token punctuation">(</span>
                <span class="token keyword">const</span> Vec2f <span class="token operator">&amp;</span>objPos<span class="token punctuation">,</span> <span class="token keyword">const</span> Vec2f <span class="token operator">&amp;</span>expDir<span class="token punctuation">,</span>
                BlockingHandler block<span class="token punctuation">,</span>
                Vec2f <span class="token operator">&amp;</span>newDir<span class="token punctuation">,</span>
                <span class="token keyword">int</span> slidable <span class="token operator">=</span> <span class="token number">5</span>
              <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_objSize <span class="token operator">==</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_tileSize <span class="token operator">==</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Real expDirX <span class="token operator">=</span> expDir<span class="token punctuation">.</span>x<span class="token punctuation">,</span> expDirY <span class="token operator">=</span> expDir<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">tend</span><span class="token punctuation">(</span> <span class="token comment">// Tend straightforward.</span>
                  objPos<span class="token punctuation">,</span> expDir<span class="token punctuation">,</span>
                  block<span class="token punctuation">,</span>
                  newDir<span class="token punctuation">,</span>
                  slidable<span class="token punctuation">,</span>
                  <span class="token operator">&amp;</span>_objSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_tileSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_offset
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">)</span>
                  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slidable<span class="token punctuation">)</span>
                  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>expDirX<span class="token punctuation">)</span> <span class="token operator">!=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">||</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>expDirY<span class="token punctuation">)</span> <span class="token operator">!=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// The movement has been redirected.</span>
                  <span class="token keyword">const</span> Vec2f <span class="token function">newExpDir</span><span class="token punctuation">(</span>newDir<span class="token punctuation">.</span>x<span class="token punctuation">,</span> newDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  Vec2f <span class="token function">newNewDir</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  n <span class="token operator">=</span> <span class="token function">tend</span><span class="token punctuation">(</span> <span class="token comment">// Tend into a new direction.</span>
                    objPos<span class="token punctuation">,</span> newExpDir<span class="token punctuation">,</span>
                    block<span class="token punctuation">,</span>
                    newNewDir<span class="token punctuation">,</span>
                    slidable<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>_objSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_tileSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_offset
                  <span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">!=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newNewDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">||</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">!=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>newNewDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Neither passable.</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> n<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token keyword">private</span><span class="token punctuation">:</span>
              <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T <span class="token operator">=</span> Real<span class="token operator">&gt;</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tend</span><span class="token punctuation">(</span>
                <span class="token keyword">const</span> Vec2f <span class="token operator">&amp;</span>objPos<span class="token punctuation">,</span> <span class="token keyword">const</span> Vec2f <span class="token operator">&amp;</span>expDir<span class="token punctuation">,</span>
                BlockingHandler block<span class="token punctuation">,</span>
                Vec2f <span class="token operator">&amp;</span>newDir<span class="token punctuation">,</span>
                <span class="token keyword">int</span> slidable<span class="token punctuation">,</span>
                <span class="token keyword">const</span> Vec2i<span class="token operator">*</span> objSize_<span class="token punctuation">,</span> <span class="token keyword">const</span> Vec2i<span class="token operator">*</span> tileSize_<span class="token punctuation">,</span> <span class="token keyword">const</span> Vec2f<span class="token operator">*</span> offset
              <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Prepare.</span>
                <span class="token keyword">typedef</span> T Number<span class="token punctuation">;</span>
                constexpr <span class="token keyword">const</span> Number EPSILON <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0.000001</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                constexpr <span class="token keyword">const</span> Number MARGIN <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">1.001</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Vec2i objSize <span class="token operator">=</span> objSize_ <span class="token operator">?</span> <span class="token operator">*</span>objSize_ <span class="token punctuation">:</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span>GRID_DEFAULT_SIZE<span class="token punctuation">,</span> GRID_DEFAULT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Vec2i tileSize <span class="token operator">=</span> tileSize_ <span class="token operator">?</span> <span class="token operator">*</span>tileSize_ <span class="token punctuation">:</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span>GRID_DEFAULT_SIZE<span class="token punctuation">,</span> GRID_DEFAULT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> expDir<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  newDir<span class="token punctuation">.</span>x <span class="token operator">=</span> newDir<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Calculate the edges and center position.</span>
                <span class="token keyword">const</span> Number objWidth <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number objHeight <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number objLocalX0 <span class="token operator">=</span> <span class="token operator">-</span>objWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number objLocalX1 <span class="token operator">=</span> objWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number objLocalY0 <span class="token operator">=</span> <span class="token operator">-</span>objHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number objLocalY1 <span class="token operator">=</span> objHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                Number centerX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objPos<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> objWidth <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Number centerY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">+</span> objHeight <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  centerX <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>offset<span class="token operator">-</span><span class="token operator">&gt;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  centerY <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>offset<span class="token operator">-</span><span class="token operator">&gt;</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Resolve.</span>
                Number dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Number dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Number dampingX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Number dampingY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number stepHeight <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objHeight <span class="token operator">-</span> MARGIN <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number stepY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>stepHeight <span class="token operator">/</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ceil</span><span class="token punctuation">(</span>stepHeight <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dirX <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> blocked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  Number diffX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> Number frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> objLocalX1<span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>Number j <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objLocalY0 <span class="token operator">+</span> MARGIN<span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> objLocalY1<span class="token punctuation">;</span> j <span class="token operator">+</span><span class="token operator">=</span> stepY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> Number frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>blk<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>blk<span class="token punctuation">.</span>pass <span class="token operator">&amp;</span> RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number diff <span class="token operator">=</span> frontTileIdxX <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>x <span class="token operator">-</span> frontX<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&lt;</span> diffX<span class="token punctuation">)</span>
                        diffX <span class="token operator">=</span> diff<span class="token punctuation">;</span>
                      dampingX <span class="token operator">-</span><span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">++</span>blocked<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">++</span>total<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>diffX <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dirX <span class="token operator">+</span><span class="token operator">=</span> diffX<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirX<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> EPSILON<span class="token punctuation">)</span>
                      dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirX <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>blocked<span class="token punctuation">)</span> <span class="token operator">/</span> total <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&gt;</span> slidable<span class="token punctuation">)</span>
                    dampingX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dirX <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> blocked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  Number diffX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> Number frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> objLocalX0<span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>Number j <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objLocalY0 <span class="token operator">+</span> MARGIN<span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> objLocalY1<span class="token punctuation">;</span> j <span class="token operator">+</span><span class="token operator">=</span> stepY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> Number frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>blk<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>blk<span class="token punctuation">.</span>pass <span class="token operator">&amp;</span> LEFT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number diff <span class="token operator">=</span> frontTileIdxX <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>x <span class="token operator">+</span> tileSize<span class="token punctuation">.</span>x <span class="token operator">-</span> frontX<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&gt;</span> diffX<span class="token punctuation">)</span>
                        diffX <span class="token operator">=</span> diff<span class="token punctuation">;</span>
                      dampingX <span class="token operator">-</span><span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">++</span>blocked<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">++</span>total<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>diffX <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dirX <span class="token operator">+</span><span class="token operator">=</span> diffX<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirX<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> EPSILON<span class="token punctuation">)</span>
                      dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirX <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>blocked<span class="token punctuation">)</span> <span class="token operator">/</span> total <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&gt;</span> slidable<span class="token punctuation">)</span>
                    dampingX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">const</span> Number stepWidth <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objWidth <span class="token operator">-</span> MARGIN <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> Number stepX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>stepWidth <span class="token operator">/</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ceil</span><span class="token punctuation">(</span>stepWidth <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dirY <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> blocked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  Number diffY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> Number frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> objLocalY1<span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>Number i <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objLocalX0 <span class="token operator">+</span> MARGIN<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objLocalX1<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> stepX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> Number frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> i<span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>blk<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>blk<span class="token punctuation">.</span>pass <span class="token operator">&amp;</span> DOWN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number diff <span class="token operator">=</span> frontTileIdxY <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>y <span class="token operator">-</span> frontY<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&lt;</span> diffY<span class="token punctuation">)</span>
                        diffY <span class="token operator">=</span> diff<span class="token punctuation">;</span>
                      dampingY <span class="token operator">-</span><span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">++</span>blocked<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">++</span>total<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>diffY <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dirY <span class="token operator">+</span><span class="token operator">=</span> diffY<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirY<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> EPSILON<span class="token punctuation">)</span>
                      dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirY <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>blocked<span class="token punctuation">)</span> <span class="token operator">/</span> total <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&gt;</span> slidable<span class="token punctuation">)</span>
                    dampingY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dirY <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> blocked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  Number diffY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> Number frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> objLocalY0<span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>Number i <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>objLocalX0 <span class="token operator">+</span> MARGIN<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objLocalX1<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> stepX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> Number frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> i<span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>blk<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>blk<span class="token punctuation">.</span>pass <span class="token operator">&amp;</span> UP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number diff <span class="token operator">=</span> frontTileIdxY <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>y <span class="token operator">+</span> tileSize<span class="token punctuation">.</span>y <span class="token operator">-</span> frontY<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&gt;</span> diffY<span class="token punctuation">)</span>
                        diffY <span class="token operator">=</span> diff<span class="token punctuation">;</span>
                      dampingY <span class="token operator">-</span><span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">++</span>blocked<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">++</span>total<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>diffY <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dirY <span class="token operator">+</span><span class="token operator">=</span> diffY<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirY<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> EPSILON<span class="token punctuation">)</span>
                      dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirY <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>blocked<span class="token punctuation">)</span> <span class="token operator">/</span> total <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&gt;</span> slidable<span class="token punctuation">)</span>
                    dampingY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Slide.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>slidable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirX <span class="token operator">==</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> expDir<span class="token punctuation">.</span>x <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> expDir<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dampingX <span class="token operator">==</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      dirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number expDirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      Number frontX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirX <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> objLocalX1<span class="token punctuation">;</span>
                      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirX <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        frontX <span class="token operator">=</span> centerX <span class="token operator">+</span> objLocalX0<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirX <span class="token operator">!=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> Number frontY <span class="token operator">=</span> centerY<span class="token punctuation">;</span>
                        <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blk<span class="token punctuation">.</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>dampingX <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            dirY <span class="token operator">=</span> <span class="token punctuation">(</span>frontTileIdxY <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token punctuation">(</span>frontY <span class="token operator">+</span> objLocalY1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token keyword">else</span> <span class="token comment">/* if (dampingX &gt; Number(0)) */</span>
                            dirY <span class="token operator">=</span> frontTileIdxY <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token punctuation">(</span>frontY <span class="token operator">+</span> objLocalY0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirY<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>expDirX<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            dirY <span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>dirY<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>expDirX<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirY <span class="token operator">==</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> expDir<span class="token punctuation">.</span>y <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> expDir<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dampingY <span class="token operator">==</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      dirX <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token keyword">const</span> Number expDirY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>expDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      Number frontY <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirY <span class="token operator">&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> objLocalY1<span class="token punctuation">;</span>
                      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirY <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        frontY <span class="token operator">=</span> centerY <span class="token operator">+</span> objLocalY0<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>expDirY <span class="token operator">!=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> Number frontX <span class="token operator">=</span> centerX<span class="token punctuation">;</span>
                        <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontX <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> <span class="token keyword">int</span> frontTileIdxY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">floor</span><span class="token punctuation">(</span>frontY <span class="token operator">/</span> tileSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> Blocking blk <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Vec2i</span><span class="token punctuation">(</span>frontTileIdxX<span class="token punctuation">,</span> frontTileIdxY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blk<span class="token punctuation">.</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>dampingY <span class="token operator">&lt;</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            dirX <span class="token operator">=</span> <span class="token punctuation">(</span>frontTileIdxX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token punctuation">(</span>frontX <span class="token operator">+</span> objLocalX1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token keyword">else</span> <span class="token comment">/* if (dampingY &gt; Number(0)) */</span>
                            dirX <span class="token operator">=</span> frontTileIdxX <span class="token operator">*</span> tileSize<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token punctuation">(</span>frontX <span class="token operator">+</span> objLocalX0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>dirX<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>expDirY<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            dirX <span class="token operator">=</span> Math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sign</span><span class="token punctuation">(</span>dirX<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">std</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abs</span><span class="token punctuation">(</span>expDirY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Accept.</span>
                newDir <span class="token operator">=</span> <span class="token function">Vec2f</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Real<span class="token punctuation">)</span>dirX<span class="token punctuation">,</span> <span class="token punctuation">(</span>Real<span class="token punctuation">)</span>dirY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>newDir<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token keyword">private</span><span class="token punctuation">:</span>
              Vec2i _objSize <span class="token operator">=</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span>GRID_DEFAULT_SIZE<span class="token punctuation">,</span> GRID_DEFAULT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              Vec2i _tileSize <span class="token operator">=</span> <span class="token function">Vec2i</span><span class="token punctuation">(</span>GRID_DEFAULT_SIZE<span class="token punctuation">,</span> GRID_DEFAULT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              Vec2f _offset <span class="token operator">=</span> <span class="token function">Vec2f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            #<span class="token keyword">endif</span> <span class="token comment">/* __WALKER_H__ */</span></code></pre>
            <p>Usage:</p>
            <pre class=" language-cpp"><code class=" language-cpp" style="font: 16px Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace, sans-serif;">Walker<span class="token operator">*</span> walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Walker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> Vec2f <span class="token function">objPos</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> Vec2f <span class="token function">expDir</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vec2f newDir<span class="token punctuation">;</span>
            walker<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">solve</span><span class="token punctuation">(</span>
              objPos<span class="token punctuation">,</span> expDir<span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Vec2i <span class="token operator">&amp;</span>pos<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Walker<span class="token punctuation">:</span><span class="token punctuation">:</span>Blocking <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Walker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Blocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              newDir<span class="token punctuation">,</span>
              <span class="token number">5</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            delete walker<span class="token punctuation">;</span></code></pre>
            <p>[<a href="https://paladin-t.github.io/">Home</a>|<a href="https://paladin-t.github.io/#articles">All articles</a>|<a href="https://paladin-t.github.io/articles/smooth-tile-based-movement-algorithm-with-sliding.html">Permalink</a>]</p>
          <!--  END CONTENT  -->
          <br>
          <br>
          Loading content...
        </div>
        <div id="article-labels">
        </div>
        <div id="article-rss" style="padding-top: 8px;">
        </div>
        <hr>
        <div id="article-comments">
          Loading comments...
        </div>
      </div>

      <hr>
      <p align="center">
        (C) 2018-2021 <a href="https://paladin-t.github.io/">Tony Wang</a>
        <a href="../feed.xml" target="_blank" class="label" style="color: white;">RSS</a>
      </p>
    </div>
  </div>
  <script src="../polyfill.js"></script>
  <script src="../marked.js"></script>
  <script src="../prism.js"></script>
  <script src="../prism-cpp.js"></script>
  <script src="../prism-lua.js"></script>
  <script src="../article.js"></script>
  <script src="../site-storage.js"></script>
  <script src="../toggle-font.js"></script>
  <script type="text/javascript">
    // Article.
    (function () {
      var author = 'paladin-t';
      var repo = 'paladin-t.github.io';
      var id = '1';
      var url = 'https://github.com/' + author + '/' + repo + '/issues/' + id.toString();
      var title = 'Smooth Tile-based Movement Algorithm with Sliding';
      var overview = 'Movement is a very basic concept in video games, it could be as simple as accumulating steps to a position value. This article introduces a smooth movement algorithm with tolerant sliding, which offers good adaptivity to various tile-based scenes.';

      try {
        //Article.attach('article-title', '<a href="' + url + '">' + title + '</a>');
        //Article.attach('article-content', overview + '<br><br>Loading content...');
        Article.read(author, repo, id, {
            avatar: 'article-avatar',
            title: 'article-title',
            content: 'article-content',
            labels: 'article-labels',
            rss: 'article-rss',
            comments: 'article-comments',
            preprocess: function (html) {
              return html
                .replaceAll('<!--iframe', '<iframe')
                .replaceAll('/iframe-->', '/iframe>')
                .replaceAll('<code>', '<code class="language-auto">')
                .replaceAll('language-c++', 'language-cpp');
            },
            highlight: function () {
              Prism.highlightAll();

              toggleFont();
            }
        });
      } catch (_) {
        var html = 'Oops, cannot load article for the moment...<br>Try refersh or ';
        html += '<a href="' + url + '">click</a>';

        Article.attach('article-content', html);
        Article.attach('article-comments', 'Cannot load comments...');

        toggleFont();
      }
    })();
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112501113-5"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag () {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-112501113-5');
  </script>
</body>
</html>
